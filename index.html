<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>대장길드 참여자 체크 Ver 2.0</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #4f46e5;
      --secondary-color: #818cf8;
      --background-color: #f8fafc;
      --card-background: #ffffff;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --danger-color: #ef4444;
      --success-color: #22c55e;
    }

    body {
      background-color: var(--background-color);
      font-family: 'Noto Sans KR', sans-serif;
      font-size: 16px;
      padding: 2rem;
      color: var(--text-primary);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .card {
      background-color: var(--card-background);
      border: none;
      border-radius: 16px;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      margin-bottom: 1.5rem;
      transition: transform 0.2s ease-in-out;
    }

    .card:hover {
      transform: translateY(-2px);
    }

    .admin-delete {
      color: var(--danger-color);
      cursor: pointer;
      margin-left: 0.5rem;
      font-size: 0.9rem;
      opacity: 0.8;
      transition: opacity 0.2s ease;
    }

    .admin-delete:hover {
      opacity: 1;
    }

    .btn {
      border-radius: 8px;
      padding: 0.5rem 1rem;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .btn-primary {
      background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
      border: none;
      color: #1e293b;
      font-weight: 700;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #c2e9fb 0%, #a1c4fd 100%);
      color: #1e293b;
    }

    .btn-danger {
      background-color: var(--danger-color);
      border-color: var(--danger-color);
    }

    .btn-outline-primary {
      color: var(--primary-color);
      border-color: var(--primary-color);
    }

    .btn-outline-primary:hover {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
    }

    .btn-disabled {
      pointer-events: none;
      opacity: 0.6;
    }

    .boss-card {
      padding: 1.5rem;
    }

    .boss-card .btn {
      font-size: 0.9rem;
      padding: 0.4rem 0.8rem;
    }

    .section-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 1rem;
    }

    ul {
      padding-left: 1.2rem;
      margin-bottom: 0;
    }

    li {
      margin-bottom: 0.5rem;
      color: var(--text-secondary);
    }

    .btn-action-group {
      display: flex;
      gap: 0.75rem;
      margin-top: 1rem;
    }

    .form-control {
      border-radius: 8px;
      border: 1px solid #e2e8f0;
      padding: 0.75rem 1rem;
      font-size: 1rem;
    }

    .form-control:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1);
    }

    .input-group {
      gap: 0.5rem;
    }

    .text-muted {
      color: var(--text-secondary) !important;
    }

    h1 {
      font-weight: 700;
      color: var(--primary-color);
    }

    #scoreSummary {
      background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
      color: #1e293b;
    }

    #scoreSummary h5 {
      color: #1e293b;
      font-weight: 700;
    }

    #scoreSummary ul li {
      color: #1e293b;
    }

    .participant-list {
      margin-top: 1rem;
      padding: 0.5rem;
      background-color: rgba(0, 0, 0, 0.02);
      border-radius: 8px;
    }

    @media (max-width: 600px) {
      body {
        padding: 0.5rem;
      }
      .container {
        padding: 0;
        max-width: 100vw;
      }
      .card {
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        margin-bottom: 1rem;
        padding: 1rem !important;
      }
      .boss-card {
        padding: 1rem !important;
      }
      .section-title, h1, h5 {
        font-size: 1.1rem !important;
      }
      .input-group {
        flex-direction: column;
        gap: 0.5rem;
      }
      .input-group > input,
      .input-group > button,
      .input-group > .form-control,
      .input-group > .btn {
        width: 100% !important;
        min-width: 0 !important;
        box-sizing: border-box;
      }
      .form-control {
        font-size: 1rem;
        padding: 0.6rem 0.8rem;
      }
      .btn, .btn-sm, .btn-action-group .btn, .btn-action-group .btn-sm {
        width: 100% !important;
        font-size: 0.95rem !important;
        padding: 0.45rem 0.5rem !important;
        min-width: 0 !important;
        box-sizing: border-box;
      }
      .btn-action-group {
        gap: 0.2rem;
        margin-top: 0.5rem;
        margin-bottom: 0.5rem;
      }
      .participant-list {
        padding: 0.3rem;
      }
      #scoreSummary {
        padding: 1rem !important;
        font-size: 0.95rem;
      }
      .card-title {
        margin-bottom: 0.5rem !important;
      }
      .text-muted.mb-3 {
        margin-bottom: 0.5rem !important;
      }
      .d-flex.justify-content-between.align-items-center.mb-4 {
        flex-direction: row !important;
        flex-wrap: wrap !important;
        align-items: flex-start !important;
        gap: 0.7rem;
      }
      .ms-auto {
        margin-left: auto !important;
      }
      #adminButton {
        margin-bottom: 0 !important;
      }
      #authInfo {
        width: 100%;
        margin-top: 0.5rem;
      }
      #authStatus {
        word-break: break-all;
      }
      #authInfo button {
        margin-left: 0.5rem;
      }
      .d-flex.gap-2 {
        flex-direction: row !important;
        justify-content: flex-end !important;
        align-items: center !important;
        width: 100%;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
      }
      .d-flex.gap-2 > .btn,
      .d-flex.justify-content-between.align-items-center.mb-2 > .btn {
        width: auto !important;
        min-width: 0 !important;
        font-size: 0.95rem !important;
        padding: 0.3rem 0.7rem !important;
      }
      .btn-cancel-red, .btn-primary {
        min-width: 0;
        padding: 0.45rem 0.7rem;
        font-size: 0.95rem;
      }
    }

    #showMoreScores {
      background: linear-gradient(135deg, #4f8bfd 0%, #6ee7f7 100%);
      color: #fff !important;
      border: none !important;
      font-weight: 700;
      box-shadow: 0 2px 8px rgba(79,139,253,0.08);
      border-radius: 8px;
      transition: background 0.2s;
    }
    #showMoreScores:hover, #showMoreScores:focus {
      background: linear-gradient(135deg, #2563eb 0%, #38bdf8 100%);
      color: #fff !important;
    }

    .btn-participate {
      border: 2px solid #ef4444 !important;
      color: #ef4444 !important;
      background: #fff !important;
      font-weight: 700;
      min-width: 64px;
      text-align: center;
      border-radius: 8px;
      transition: background 0.2s, color 0.2s;
    }
    .btn-participate:hover, .btn-participate:focus {
      background: #ffe4e6 !important;
      color: #b91c1c !important;
    }

    .btn-cancel-red {
      background: linear-gradient(135deg, #f87171 0%, #ef4444 100%) !important;
      color: #fff !important;
      border: none !important;
      font-weight: 700;
      min-width: 80px;
      text-align: center;
      border-radius: 8px;
      font-size: 1rem;
      padding: 0.45rem 1.2rem;
      transition: background 0.2s, color 0.2s;
    }
    .btn-cancel-red:hover, .btn-cancel-red:focus {
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%) !important;
      color: #fff !important;
    }
    .btn-primary {
      min-width: 80px;
      padding: 0.45rem 1.2rem;
      font-weight: 700;
      border-radius: 8px;
      text-align: center;
      font-size: 1rem;
    }

    /* 탭 디자인 추가 */
    .nav-tabs {
      border: none;
      margin-bottom: 1rem;
      gap: 0.5rem;
    }

    .nav-tabs .nav-item {
      margin: 0;
    }

    .nav-tabs .nav-link {
      border: none;
      color: var(--text-secondary);
      font-weight: 600;
      padding: 0.75rem 1.5rem;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.5);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .nav-tabs .nav-link:hover {
      color: var(--primary-color);
      background: rgba(255, 255, 255, 0.8);
    }

    .nav-tabs .nav-link.active {
      color: #fff;
      background: linear-gradient(135deg, #4f8bfd 0%, #6ee7f7 100%);
      box-shadow: 0 4px 15px rgba(79, 139, 253, 0.2);
      transform: translateY(-1px);
    }

    .nav-tabs .nav-link.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 3px;
    }

    @media (max-width: 600px) {
      .nav-tabs {
        flex-direction: row;
        justify-content: center;
        gap: 0.3rem;
      }
      
      .nav-tabs .nav-link {
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
      }
    }
  </style>
</head>
<body>
<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
    <h1 class="h3 mb-0">대장길드 참여자 체크 Ver 2.0</h1>
    <div class="ms-auto">
      <button id="adminButton" class="btn btn-outline-primary btn-sm" onclick="setAdmin()">관리자 설정</button>
      <button id="detailEditBtn" class="btn btn-outline-primary btn-sm ms-2" style="display:none;" data-bs-toggle="modal" data-bs-target="#detailEditModal">상세수정</button>
    </div>
    <div id="authInfo" class="d-none mt-2">
      <span class="me-2">로그인: <strong id="authStatus">-</strong></span>
      <button class="btn btn-outline-primary btn-sm" onclick="logout()">로그아웃</button>
    </div>
  </div>

  <div id="scoreSummary" class="card p-4 mb-4">
    <ul class="nav nav-tabs" id="scoreTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="total-tab" data-bs-toggle="tab" data-bs-target="#total" type="button" role="tab" aria-controls="total" aria-selected="true" onclick="resetShowAll()">누적</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="weekly-tab" data-bs-toggle="tab" data-bs-target="#weekly" type="button" role="tab" aria-controls="weekly" aria-selected="false" onclick="resetShowAll()">주간</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="custom-tab" data-bs-toggle="tab" data-bs-target="#custom" type="button" role="tab" aria-controls="custom" aria-selected="false" onclick="resetShowAll()">기간별</button>
      </li>
    </ul>
    <div class="tab-content" id="scoreTabContent">
      <div class="tab-pane fade show active" id="total" role="tabpanel" aria-labelledby="total-tab"></div>
      <div class="tab-pane fade" id="weekly" role="tabpanel" aria-labelledby="weekly-tab"></div>
      <div class="tab-pane fade" id="custom" role="tabpanel" aria-labelledby="custom-tab">
        <div class="custom-period-inputs mb-3">
          <div class="row g-2">
            <div class="col-md-5">
              <input type="datetime-local" id="customStartDate" class="form-control" placeholder="시작일">
            </div>
            <div class="col-md-5">
              <input type="datetime-local" id="customEndDate" class="form-control" placeholder="종료일">
            </div>
            <div class="col-md-2">
              <button class="btn btn-outline-light btn-sm" onclick="displayCustomScores()" style="background: linear-gradient(135deg, #4f8bfd 0%, #6ee7f7 100%); color: #fff !important; border: none !important; font-weight: 700; box-shadow: 0 2px 8px rgba(79,139,253,0.08); border-radius: 8px; transition: background 0.2s; width: 100%;">조회</button>
            </div>
          </div>
        </div>
        <div id="customScores"></div>
      </div>
    </div>
  </div>

  <div class="card p-4 mb-4">
    <h5 class="section-title">닉네임 설정</h5>
    <div class="input-group">
      <input id="nickname" class="form-control" placeholder="닉네임을 입력해주세요">
      <button class="btn btn-primary" onclick="saveNickname()">저장</button>
    </div>
  </div>

  <div id="adminSection" class="card p-4 mb-4 d-none">
    <h5 class="section-title">보스 정보 등록</h5>
    <div class="input-group">
      <input id="bossId" class="form-control" placeholder="보스 이름을 입력해주세요">
      <input id="bossScore" class="form-control" type="number" placeholder="점수를 입력해주세요">
      <input id="bossTime" class="form-control" type="datetime-local">
      <button class="btn btn-primary" onclick="openBoss()">보스 오픈</button>
    </div>
  </div>

  <div class="card p-4">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5 class="section-title mb-0">오픈된 보스</h5>
      <button class="btn btn-outline-primary btn-sm" onclick="downloadCSV()">CSV 다운로드</button>
    </div>
    <div style="margin:0.2rem 0 0.5rem 0; color:#1976d2; font-size:0.98rem; font-weight:500;">
      안내 : 보스 지정된 오픈시간 후 6시간 동안 참여 선택이 가능합니다.
    </div>
    <div class="d-flex gap-2">
      <button id="deleteAllButton" class="btn btn-outline-danger btn-sm" onclick="confirmAndDeleteAll()">전체 삭제</button>
    </div>
    <div id="bossList"></div>
  </div>
</div>

<!-- 상세수정 모달 -->
<div class="modal fade" id="detailEditModal" tabindex="-1" aria-labelledby="detailEditModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="detailEditModalLabel">상세 데이터 수정</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="detailEditModalBody">
        <div id="adminDetailSection">
          <div class="card mb-4">
            <div class="card-header">누락 데이터 추가</div>
            <div class="card-body">
              <div class="row g-2">
                <div class="col-12 mb-2"><input id="missingBossId_modal" class="form-control" placeholder="보스 ID"></div>
                <div class="col"><input id="missingBossTime_modal" class="form-control" type="datetime-local"></div>
                <div class="col"><input id="missingNick_modal" class="form-control" placeholder="닉네임"></div>
                <div class="col"><input id="missingScore_modal" class="form-control" type="number" placeholder="점수"></div>
                <div class="col-auto"><button class="btn btn-primary" onclick="addMissingData_modal()">추가</button></div>
              </div>
            </div>
          </div>
          <div class="card mb-4">
            <div class="card-header">참여자 수정</div>
            <div class="card-body">
              <select id="bossSelect_modal" class="form-select mb-2" onchange="loadParticipantsTable_modal()">
                <option value="">보스 선택</option>
              </select>
              <table class="table table-striped table-hover">
                <tbody id="participantTable_modal"></tbody>
              </table>
              <div class="row g-2 mb-2">
                <div class="col"><input id="editNick_modal" class="form-control" readonly placeholder="선택된 닉네임"></div>
                <div class="col"><input id="editScore_modal" class="form-control" type="number" placeholder="현재 점수"></div>
                <div class="col-auto"><button class="btn btn-primary" onclick="updateParticipantScore_modal()">점수 수정</button></div>
              </div>
              <div class="row g-2 mb-2">
                <div class="col"><input id="newNick_modal" class="form-control" placeholder="새 닉네임"></div>
                <div class="col-auto"><button class="btn btn-warning" onclick="changeParticipantNick_modal()">닉네임 변경</button></div>
              </div>
              <hr/>
              <div class="row g-2 mb-2">
                <div class="col"><input id="addNick_modal" class="form-control" placeholder="추가할 닉네임"></div>
                <div class="col"><input id="addScore_modal" class="form-control" type="number" placeholder="점수"></div>
                <div class="col-auto"><button class="btn btn-success" onclick="addParticipantToBoss_modal()">참여자 추가</button></div>
              </div>
            </div>
          </div>
          <div class="card mb-4">
            <div class="card-header">보스 ID 수정</div>
            <div class="card-body row g-2">
              <div class="col"><input id="newBossId_modal" class="form-control" placeholder="새 보스 ID"></div>
              <div class="col-auto"><button class="btn btn-danger" onclick="changeBossId_modal()">보스 ID 변경</button></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAY6Ff6uZ-iZ7soeuXBU0mtTKKZZ8gAPck",
  authDomain: "bossraidtracker.firebaseapp.com",
  databaseURL: "https://bossraidtracker-default-rtdb.firebaseio.com",
  projectId: "bossraidtracker",
  storageBucket: "bossraidtracker.appspot.com",
  messagingSenderId: "975753692062",
  appId: "1:975753692062:web:0991fb5bcbc52a9d3d0c8f"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

function saveNickname() {
  let nickname = document.getElementById("nickname").value;
  nickname = nickname.replace(/\s/g, "");
  localStorage.setItem("nickname", nickname);
  document.getElementById("nickname").value = nickname;
  alert("닉네임이 성공적으로 저장되었습니다.");
}

function setAdmin() {
  const email = prompt("관리자 이메일을 입력해주세요:");
  const password = prompt("관리자 비밀번호를 입력해주세요:");
  if (email === "dogfightda@gmail.com" && password === "0716") {
    localStorage.setItem("admin", email);
    alert("관리자 인증이 완료되었습니다.");
    checkAdmin();
    location.reload();
  } else alert("관리자 인증에 실패했습니다. 이메일과 비밀번호를 다시 확인해주세요.");
}

function logout() {
  localStorage.removeItem("admin");
  alert("로그아웃이 완료되었습니다.");
  location.reload();
}

function isAdmin() {
  return localStorage.getItem("admin") === "dogfightda@gmail.com";
}

function checkAdmin() {
  document.getElementById("adminSection").classList.toggle("d-none", !isAdmin());
  document.getElementById("authInfo").classList.toggle("d-none", !isAdmin());
  document.getElementById("adminButton").classList.toggle("d-none", isAdmin());
  document.getElementById("deleteAllButton").style.display = isAdmin() ? "inline-block" : "none";
  // 상세수정 버튼 표시
  const detailBtn = document.getElementById("detailEditBtn");
  if(detailBtn) detailBtn.style.display = isAdmin() ? "inline-block" : "none";
  document.getElementById("authStatus").textContent = isAdmin() ? localStorage.getItem("admin") : "-";
}

function openBoss() {
  const bossId = document.getElementById("bossId").value.trim();
  const scoreInput = document.getElementById("bossScore").value.trim();
  const score = parseInt(scoreInput);
  const timeInput = document.getElementById("bossTime").value;
  const timestamp = timeInput ? new Date(timeInput).getTime() : Date.now();

  if (!bossId) return alert("보스 이름을 입력해주세요.");
  if (!scoreInput || isNaN(score)) return alert("점수를 올바른 숫자로 입력해주세요.");
  db.ref("bosses/"+bossId).set({open:true,timestamp:timestamp,score}).then(()=>location.reload());
}

function participate(bossId){
  const nickname=localStorage.getItem("nickname");
  if(!nickname)return alert("닉네임을 먼저 저장해주세요.");
  db.ref(`bosses/${bossId}/score`).once("value",snap=>{
    const score=snap.val()||0;
    db.ref(`bosses/${bossId}/participants/${nickname}`).set({score}).then(()=>location.reload());
  });
}

function cancelParticipation(bossId){
  const nickname = localStorage.getItem("nickname");
  if (!nickname) return alert("닉네임을 먼저 저장해주세요.");
  if (confirm("정말로 보스 참여를 취소하시겠습니까?")) {
    db.ref(`bosses/${bossId}/participants/${nickname}`).remove().then(()=>location.reload());
  }
}

function deleteBoss(bossId){
  if(confirm("해당 보스 정보를 삭제하시겠습니까?"))db.ref("bosses/"+bossId).remove().then(()=>location.reload());
}

function deleteParticipant(bossId,nick){
  if(confirm("해당 참여자의 정보를 삭제하시겠습니까?"))db.ref(`bosses/${bossId}/participants/${nick}`).remove().then(()=>location.reload());
}

function confirmAndDeleteAll(){
  if(!isAdmin()){ alert("관리자만 삭제할 수 있는 기능입니다."); return; }
  if(confirm("모든 보스 정보와 참여자 정보가 삭제됩니다. 정말로 진행하시겠습니까?")) db.ref("bosses").remove().then(()=>location.reload());
}

function loadBosses(){
  db.ref("bosses").on("value",snap=>{
    const data=snap.val(),now=Date.now(),cont=document.getElementById("bossList");cont.innerHTML="";
    const sortedIds = Object.keys(data).sort((a,b)=>data[b].timestamp - data[a].timestamp);
    for(const id of sortedIds){
      const boss=data[id],open=boss.timestamp,within=(now-open)<21600000;
      let html = `<div class="card boss-card mb-3">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <h5 class="card-title mb-2">${id}
            ${isAdmin()?`<span class="admin-delete" onclick="deleteBoss('${id}')">[삭제]</span>`:""}</h5>
            <div class="text-muted mb-3">${new Date(open).toLocaleString("ko-KR")}</div>
          </div>
          <div class="btn-action-group">
            <button class="btn btn-sm ${within ? 'btn-primary' : 'btn-secondary'}" onclick="${within ? `participate('${id}')` : "alert('참여 가능 시간이 지났습니다.')"}" style="${!within ? 'background: #6c757d !important; border: none !important; color: #fff !important; min-width: 80px; padding: 0.45rem 1.2rem; font-size: 1rem;' : ''}">${within ? "참여" : "불가"}</button>
            <button class="btn btn-sm btn-cancel-red" onclick="cancelParticipation('${id}')">취소</button>
          </div>
        </div>
        <div class="participant-list">
          <ul class="mt-2">`;
      if (boss.participants) {
        const sortedNicks = Object.entries(boss.participants).sort((a, b) => a[0].localeCompare(b[0]));
        for (const [nick, info] of sortedNicks) {
          html += `<li>${nick} <span class="text-muted">(${info.score}점)</span> ${isAdmin()?`<span class="admin-delete" onclick="deleteParticipant('${id}','${nick}')">[삭제]</span>`:""}</li>`;
        }
      } else html += "<li class='text-muted'>참여자 없음</li>";
      html += "</ul></div></div>";
      cont.innerHTML += html;
    }
  });
}

function displayTotalScores(){
  db.ref("bosses").once("value",snap=>{
    const data=snap.val(),scores={},participation={};
    // 총 보스 수 계산
    const totalBosses = Object.keys(data).length;
    
    for(const id in data){
      const boss=data[id];
      if(boss.participants){
        for(const nick in boss.participants){
          const score=boss.participants[nick].score||0;
          scores[nick]=(scores[nick]||0)+score;
          // 참여한 보스 수 계산
          participation[nick] = (participation[nick] || 0) + 1;
        }
      }
    }
    const sorted=Object.entries(scores).sort((a,b)=>b[1]-a[1]);
    let showAll = false;
    function renderList() {
      const displayList = showAll ? sorted : sorted.slice(0, 5);
      const html = displayList.map(([n,s],index)=>{
        const participated = participation[n] || 0;
        const participationRate = ((participated / totalBosses) * 100).toFixed(1);
        return `<li><strong>${index + 1}등</strong> ${n}: ${s}점 <span style="font-size: 70%">( 건수 : ${participated} | 참여율 : ${participationRate}%)</span></li>`;
      }).join('');
      document.getElementById('total').innerHTML =
        `<h5 class='mb-2'>닉네임별 누적 점수</h5>
        <ul>${html}</ul>
        ${sorted.length > 5 ? `<button id='showMoreScores' class='btn btn-outline-light btn-sm mt-2'>${showAll ? '접기' : '더보기'}</button>` : ''}`;
      if(sorted.length > 5) {
        document.getElementById('showMoreScores').onclick = () => {
          showAll = !showAll;
          renderList();
        };
      }
    }
    renderList();
  });
}

function displayWeeklyScores() {
  db.ref("bosses").once("value", snap => {
    const data = snap.val();
    const scores = {};
    const participation = {};
    
    // 현재 시간 기준으로 이번 주 수요일 9시와 다음 주 수요일 9시 사이의 시간 계산
    const now = new Date();
    const currentDay = now.getDay(); // 0: 일요일, 3: 수요일
    const currentHour = now.getHours();
    
    // 이번 주 수요일 9시 계산
    let thisWed = new Date(now);
    thisWed.setHours(9, 0, 0, 0);
    // 이번 주 수요일까지 며칠 남았는지 계산 (일요일=0, 수요일=3)
    const diffToWed = (3 - thisWed.getDay() + 7) % 7;
    thisWed.setDate(thisWed.getDate() + diffToWed);
    // 만약 오늘이 수요일이고 9시 이전이면, 지난주 수요일 9시로 이동
    if (now < thisWed) {
      thisWed.setDate(thisWed.getDate() - 7);
    }
    // 시작: 이번 주 수요일 9시
    const startDate = new Date(thisWed);
    // 끝: 다음 주 수요일 9시
    const endDate = new Date(thisWed);
    endDate.setDate(endDate.getDate() + 7);
    // 집계는 끝-1초까지
    const endTimestamp = endDate.getTime() - 1000;
    const startTimestamp = startDate.getTime();
    // 표기용: 1분 빼서 08:59로
    const displayEndDate = new Date(endDate.getTime() - 60 * 1000);
    
    // 주간 보스 수 계산
    const weeklyBosses = Object.values(data).filter(boss => 
      boss.timestamp >= startTimestamp && boss.timestamp <= endTimestamp
    ).length;
    
    // 주간 점수 계산
    for(const id in data) {
      const boss = data[id];
      if(boss.timestamp >= startTimestamp && boss.timestamp <= endTimestamp && boss.participants) {
        for(const nick in boss.participants) {
          const score = boss.participants[nick].score || 0;
          scores[nick] = (scores[nick] || 0) + score;
          participation[nick] = (participation[nick] || 0) + 1;
        }
      }
    }
    
    const sorted = Object.entries(scores).sort((a,b) => b[1] - a[1]);
    let showAll = false;
    
    function renderList() {
      const displayList = showAll ? sorted : sorted.slice(0, 5);
      const html = displayList.map(([n,s], index) => {
        const participated = participation[n] || 0;
        const participationRate = ((participated / weeklyBosses) * 100).toFixed(1);
        return `<li><strong>${index + 1}등</strong> ${n}: ${s}점 <span style="font-size: 70%">( 건수 : ${participated} | 참여율 : ${participationRate}%)</span></li>`;
      }).join('');
      
      const periodText = `${startDate.getMonth() + 1}월 ${startDate.getDate()}일 (${['일', '월', '화', '수', '목', '금', '토'][startDate.getDay()]}) ${String(startDate.getHours()).padStart(2, '0')}:${String(startDate.getMinutes()).padStart(2, '0')} ~ ${displayEndDate.getMonth() + 1}월 ${displayEndDate.getDate()}일 (${['일', '월', '화', '수', '목', '금', '토'][displayEndDate.getDay()]}) ${String(displayEndDate.getHours()).padStart(2, '0')}:${String(displayEndDate.getMinutes()).padStart(2, '0')}`;
      
      document.getElementById('weekly').innerHTML =
        `<h5 class='mb-2'>닉네임별 주간 점수</h5>
        <div class="text-muted mb-3" style="font-size: 0.9rem;">${periodText}</div>
        <ul>${html}</ul>
        ${sorted.length > 5 ? `<button id='showMoreWeeklyScores' class='btn btn-outline-light btn-sm mt-2' style="background: linear-gradient(135deg, #4f8bfd 0%, #6ee7f7 100%); color: #fff !important; border: none !important; font-weight: 700; box-shadow: 0 2px 8px rgba(79,139,253,0.08); border-radius: 8px; transition: background 0.2s;">${showAll ? '접기' : '더보기'}</button>` : ''}`;
        
      if(sorted.length > 5) {
        document.getElementById('showMoreWeeklyScores').onclick = () => {
          showAll = !showAll;
          renderList();
        };
      }
    }
    renderList();
  });
}

function displayCustomScores() {
  const startDate = document.getElementById('customStartDate').value;
  const endDate = document.getElementById('customEndDate').value;
  
  if (!startDate || !endDate) {
    alert('시작일과 종료일을 모두 선택해주세요.');
    return;
  }
  
  const startTimestamp = new Date(startDate).getTime();
  const endTimestamp = new Date(endDate).getTime();
  
  if (startTimestamp >= endTimestamp) {
    alert('종료일은 시작일보다 이후여야 합니다.');
    return;
  }
  
  db.ref("bosses").once("value", snap => {
    const data = snap.val();
    const scores = {};
    const participation = {};
    
    // 선택된 기간의 보스 수 계산
    const periodBosses = Object.values(data).filter(boss => 
      boss.timestamp >= startTimestamp && boss.timestamp <= endTimestamp
    ).length;
    
    // 선택된 기간의 점수 계산
    for(const id in data) {
      const boss = data[id];
      if(boss.timestamp >= startTimestamp && boss.timestamp <= endTimestamp && boss.participants) {
        for(const nick in boss.participants) {
          const score = boss.participants[nick].score || 0;
          scores[nick] = (scores[nick] || 0) + score;
          participation[nick] = (participation[nick] || 0) + 1;
        }
      }
    }
    
    const sorted = Object.entries(scores).sort((a,b) => b[1] - a[1]);
    let showAll = false;
    
    function renderList() {
      const displayList = showAll ? sorted : sorted.slice(0, 5);
      const html = displayList.map(([n,s], index) => {
        const participated = participation[n] || 0;
        const participationRate = ((participated / periodBosses) * 100).toFixed(1);
        return `<li><strong>${index + 1}등</strong> ${n}: ${s}점 <span style="font-size: 70%">( 건수 : ${participated} | 참여율 : ${participationRate}%)</span></li>`;
      }).join('');
      
      const periodText = `${new Date(startTimestamp).toLocaleDateString('ko-KR', {month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'})} ~ ${new Date(endTimestamp).toLocaleDateString('ko-KR', {month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'})}`;
      
      document.getElementById('customScores').innerHTML =
        `<h5 class='mb-2'>닉네임별 기간 점수</h5>
        <div class="text-muted mb-3" style="font-size: 0.9rem;">${periodText}</div>
        <ul>${html}</ul>
        ${sorted.length > 5 ? `<button id='showMoreCustomScores' class='btn btn-outline-light btn-sm mt-2' style="background: linear-gradient(135deg, #4f8bfd 0%, #6ee7f7 100%); color: #fff !important; border: none !important; font-weight: 700; box-shadow: 0 2px 8px rgba(79,139,253,0.08); border-radius: 8px; transition: background 0.2s;">${showAll ? '접기' : '더보기'}</button>` : ''}`;
        
      if(sorted.length > 5) {
        document.getElementById('showMoreCustomScores').onclick = () => {
          showAll = !showAll;
          renderList();
        };
      }
    }
    renderList();
  });
}

// 페이지 로드 시 datetime-local 입력 필드의 기본값 설정
window.addEventListener('DOMContentLoaded', function() {
  const now = new Date();
  const startDate = new Date(now);
  startDate.setDate(startDate.getDate() - 7); // 7일 전
  
  // 한국 시간으로 변환
  const formatDate = (date) => {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${year}-${month}-${day}T${hours}:${minutes}`;
  };
  
  document.getElementById('customStartDate').value = formatDate(startDate);
  document.getElementById('customEndDate').value = formatDate(now);
});

// 더보기 상태 초기화 함수 추가
function resetShowAll() {
  showAll = false;
  displayTotalScores();
  displayWeeklyScores();
  displayCustomScores();
}

window.onload=()=>{checkAdmin();displayTotalScores();displayWeeklyScores();displayCustomScores();loadBosses();};
</script>

<script>
function downloadCSV() {
  db.ref("bosses").once("value", (snap) => {
    const data = snap.val();
    // 1. 보스별 참여자 목록 시트
    let bossRows = [["보스ID","보스오픈시간","닉네임","점수"]];
    const sortedBossIds = Object.keys(data).sort((a, b) => data[b].timestamp - data[a].timestamp);
    for (const bossId of sortedBossIds) {
      const boss = data[bossId];
      const openTime = boss.timestamp ? new Date(boss.timestamp).toLocaleString("ko-KR") : "";
      if (boss.participants) {
        const sortedParticipants = Object.entries(boss.participants).sort((a, b) => a[0].localeCompare(b[0]));
        for (const [nick, info] of sortedParticipants) {
          const score = info.score || 0;
          bossRows.push([bossId, openTime, nick, score]);
        }
      } else {
        bossRows.push([bossId, openTime, "", ""]);
      }
    }
    // 2. 닉네임별 누적 점수 시트
    let scoreMap = {};
    for (const bossId in data) {
      const boss = data[bossId];
      if (boss.participants) {
        for (const nick in boss.participants) {
          const score = boss.participants[nick].score || 0;
          scoreMap[nick] = (scoreMap[nick] || 0) + score;
        }
      }
    }
    let scoreRows = [["닉네임", "누적점수"]];
    Object.entries(scoreMap).sort((a,b)=>b[1]-a[1]).forEach(([nick, score]) => {
      scoreRows.push([nick, score]);
    });
    // 3. SheetJS로 엑셀 파일 생성
    const wb = XLSX.utils.book_new();
    const ws1 = XLSX.utils.aoa_to_sheet(bossRows);
    const ws2 = XLSX.utils.aoa_to_sheet(scoreRows);
    XLSX.utils.book_append_sheet(wb, ws1, "보스별참여자");
    XLSX.utils.book_append_sheet(wb, ws2, "닉네임별누적점수");
    XLSX.writeFile(wb, "보스참여자_및_누적점수.xlsx");
  });
}
</script>

<script>
// 닉네임 입력 시 실시간으로 공백 제거
window.addEventListener('DOMContentLoaded', function() {
  var nicknameInput = document.getElementById("nickname");
  if(nicknameInput) {
    nicknameInput.addEventListener("input", function(e) {
      this.value = this.value.replace(/\s/g, "");
    });
    var saved = localStorage.getItem("nickname");
    if(saved) nicknameInput.value = saved;
  }
});
</script>

<script>
// 상세수정 모달용 함수들
function addMissingData_modal() {
  const bossId = document.getElementById("missingBossId_modal").value;
  const timeStr = document.getElementById("missingBossTime_modal").value;
  const nick = document.getElementById("missingNick_modal").value;
  const score = parseInt(document.getElementById("missingScore_modal").value) || 0;
  const timestamp = new Date(timeStr).getTime();
  if (!bossId || !nick || !timestamp) return alert("모든 값 입력 필요");
  db.ref("bosses/" + bossId).update({ open:true, timestamp:timestamp });
  db.ref("bosses/" + bossId + "/participants/" + nick).set({ score:score })
    .then(() => { alert("누락 데이터 추가 완료"); loadBossList_modal(); });
}
function loadBossList_modal() {
  db.ref("bosses").once("value", snap => {
    const data = snap.val();
    const bossSelect = document.getElementById("bossSelect_modal");
    bossSelect.innerHTML = "<option value=''>보스 선택</option>";
    for (const bossId in data) {
      bossSelect.innerHTML += `<option value="${bossId}">${bossId}</option>`;
    }
  });
  // 테이블 초기화
  document.getElementById("participantTable_modal").innerHTML = "";
  document.getElementById("editNick_modal").value = "";
  document.getElementById("editScore_modal").value = "";
  document.getElementById("newNick_modal").value = "";
  document.getElementById("addNick_modal").value = "";
  document.getElementById("addScore_modal").value = "";
  document.getElementById("newBossId_modal").value = "";
}
function loadParticipantsTable_modal() {
  const bossId = document.getElementById("bossSelect_modal").value;
  const table = document.getElementById("participantTable_modal");
  table.innerHTML = "";
  if (!bossId) return;
  db.ref("bosses/" + bossId + "/participants").once("value", snap => {
    const participants = snap.val();
    for (const nick in participants) {
      const score = participants[nick].score || 0;
      table.innerHTML += `<tr>
        <td>${nick}</td>
        <td>${score}</td>
        <td><button class="btn btn-outline-primary btn-table" onclick="selectParticipant_modal(this, '${bossId}', '${nick}', ${score})">선택</button></td>
      </tr>`;
    }
  });
}
function selectParticipant_modal(btn, bossId, nick, score) {
  document.getElementById("editNick_modal").value = nick;
  document.getElementById("editScore_modal").value = score;
  document.querySelectorAll("#participantTable_modal tr").forEach(row => row.classList.remove("selected-row"));
  btn.parentNode.parentNode.classList.add("selected-row");
}
function updateParticipantScore_modal() {
  const bossId = document.getElementById("bossSelect_modal").value;
  const nick = document.getElementById("editNick_modal").value;
  const newScore = parseInt(document.getElementById("editScore_modal").value) || 0;
  if (!bossId || !nick) return alert("보스, 닉네임 선택 필요");
  db.ref("bosses/" + bossId + "/participants/" + nick).update({ score:newScore })
    .then(() => {
      alert("점수 수정 완료");
      loadParticipantsTable_modal();
    });
}
function changeParticipantNick_modal() {
  const bossId = document.getElementById("bossSelect_modal").value;
  const oldNick = document.getElementById("editNick_modal").value;
  const newNick = document.getElementById("newNick_modal").value;
  if (!bossId || !oldNick || !newNick) return alert("모든 값 입력 필요");
  db.ref("bosses/" + bossId + "/participants/" + oldNick).once("value", snap => {
    const data = snap.val();
    if (data) {
      db.ref("bosses/" + bossId + "/participants/" + newNick).set(data);
      db.ref("bosses/" + bossId + "/participants/" + oldNick).remove()
        .then(() => {
          alert("닉네임 변경 완료");
          loadParticipantsTable_modal();
        });
    } else alert("기존 닉네임 데이터 없음");
  });
}
function changeBossId_modal() {
  const oldBossId = document.getElementById("bossSelect_modal").value;
  const newBossId = document.getElementById("newBossId_modal").value;
  if (!oldBossId) return alert("보스를 먼저 선택해주세요.");
  if (!newBossId) return alert("새 보스 ID를 입력해주세요.");
  db.ref("bosses/" + newBossId).once("value", snap => {
    if (snap.exists()) {
      alert("이미 존재하는 보스 ID입니다. 다른 ID를 입력하세요.");
    } else {
      db.ref("bosses/" + oldBossId).once("value", snap => {
        const data = snap.val();
        if (data) {
          db.ref("bosses/" + newBossId).set(data);
          db.ref("bosses/" + oldBossId).remove()
            .then(() => {
              alert("보스 ID 변경 완료");
              loadBossList_modal();
              document.getElementById("newBossId_modal").value = "";
              document.getElementById("bossSelect_modal").value = newBossId;
              loadParticipantsTable_modal();
            });
        } else alert("기존 보스 데이터 없음");
      });
    }
  });
}
function addParticipantToBoss_modal() {
  const bossId = document.getElementById("bossSelect_modal").value;
  const nick = document.getElementById("addNick_modal").value.trim();
  const score = parseInt(document.getElementById("addScore_modal").value) || 0;
  if (!bossId) return alert("보스를 먼저 선택하세요.");
  if (!nick) return alert("닉네임을 입력하세요.");
  db.ref("bosses/" + bossId + "/participants/" + nick).set({ score })
    .then(() => {
      alert("참여자 추가 완료");
      document.getElementById("addNick_modal").value = "";
      document.getElementById("addScore_modal").value = "";
      loadParticipantsTable_modal();
    });
}
// 모달 오픈 시 데이터 새로고침
const detailEditModal = document.getElementById('detailEditModal');
detailEditModal.addEventListener('show.bs.modal', function () {
  loadBossList_modal();
  // 입력값 초기화
  document.getElementById("missingBossId_modal").value = "";
  document.getElementById("missingBossTime_modal").value = "";
  document.getElementById("missingNick_modal").value = "";
  document.getElementById("missingScore_modal").value = "";
});
</script>
</body>
</html>
