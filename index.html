<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>보탐 참여 시스템</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js">
    function downloadCSV() {
      db.ref("bosses").once("value", (snap) => {
        const data = snap.val();
        let csvContent = "보스ID,보스오픈시간,닉네임\n";
        for (const bossId in data) {
          const boss = data[bossId];
          const openTime = boss.timestamp ? new Date(boss.timestamp).toLocaleString("ko-KR") : "";
          if (boss.participants) {
            for (const nick in boss.participants) {
              csvContent += `"${bossId}","${openTime}","${nick}"\n`;
            }
          } else {
            csvContent += `"${bossId}","${openTime}",""\n`;
          }
        }

        const blob = new Blob(["\uFEFF" + csvContent], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "보스참여자목록.csv";
        a.click();
        URL.revokeObjectURL(url);
      });
    }
</script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js">
    function downloadCSV() {
      db.ref("bosses").once("value", (snap) => {
        const data = snap.val();
        let csvContent = "보스ID,보스오픈시간,닉네임\n";
        for (const bossId in data) {
          const boss = data[bossId];
          const openTime = boss.timestamp ? new Date(boss.timestamp).toLocaleString("ko-KR") : "";
          if (boss.participants) {
            for (const nick in boss.participants) {
              csvContent += `"${bossId}","${openTime}","${nick}"\n`;
            }
          } else {
            csvContent += `"${bossId}","${openTime}",""\n`;
          }
        }

        const blob = new Blob(["\uFEFF" + csvContent], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "보스참여자목록.csv";
        a.click();
        URL.revokeObjectURL(url);
      });
    }
</script>
  <style>
    body {
      font-family: 'Segoe UI', 'Pretendard', sans-serif;
      margin: 0;
      padding: 2rem;
      background: #f5f7fa;
      color: #333;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }

    h1 {
      font-size: 1.5rem;
      margin: 0;
    }

    #adminButton, #authInfo {
      position: absolute;
      top: 1rem;
      right: 1rem;
    }

    #authInfo {
      background: #e3f2fd;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      display: none;
    }

    label, input, button {
      font-size: 1rem;
    }

    input {
      padding: 0.5rem;
      margin-right: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    button {
      padding: 0.5rem 1rem;
      background-color: #1976d2;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    button:hover {
      background-color: #1565c0;
    }

    .btn-disabled {
      background-color: #cfd8dc;
      color: #666;
      border: 1px dashed #999;
      cursor: not-allowed;
    }

    .section {
      margin-bottom: 2rem;
    }

    .boss {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .boss h3 {
      margin-top: 0;
    }

    .participants {
      margin-top: 0.5rem;
      font-size: 0.9rem;
    }

    .admin-delete {
      color: red;
      cursor: pointer;
      margin-left: 0.5rem;
    }
  </style>
</head>
<body>
  <header>
    <h1>🔥 보탐 참여 시스템</h1>
    <button id="adminButton" onclick="setAdmin()">🔐 관리자 설정</button>
    <div id="authInfo">
      로그인: <span id="authStatus">-</span>
      <button onclick="logout()">로그아웃</button>
    </div>
  </header>

  <div class="section">
    <label>닉네임:
      <input type="text" id="nickname" placeholder="닉네임 입력" />
    </label>
    <button onclick="saveNickname()">닉네임 저장</button>
  </div>

  <div id="adminSection" class="section" style="display:none;">
    <label>보스 ID:
      <input type="text" id="bossId" placeholder="보스 이름 자유입력" />
    </label>
    <button onclick="openBoss()">보스 오픈</button>
  </div>

  <div class="section">
    <h2>✅ 오픈된 보스</h2>
    <p style="color: #555; font-size: 0.95rem;">⚠️ 보스 오픈 후 6시간 동안만 참여버튼 선택이 가능합니다.</p>
    <button onclick="downloadCSV()">CSV 다운로드</button>
    <p style="color: #555; font-size: 0.95rem;">⚠️ 보스 오픈 후 6시간 동안만 참여버튼 선택이 가능합니다.</p>
    <div id="bossList"></div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAY6Ff6uZ-iZ7soeuXBU0mtTKKZZ8gAPck",
      authDomain: "bossraidtracker.firebaseapp.com",
      databaseURL: "https://bossraidtracker-default-rtdb.firebaseio.com",
      projectId: "bossraidtracker",
      storageBucket: "bossraidtracker.appspot.com",
      messagingSenderId: "975753692062",
      appId: "1:975753692062:web:0991fb5bcbc52a9d3d0c8f",
      measurementId: "G-MC8YY38ZP3"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function saveNickname() {
      const nickname = document.getElementById("nickname").value;
      if (nickname) {
        localStorage.setItem("nickname", nickname);
        alert("닉네임 저장 완료!");
      }
    }

    function setAdmin() {
      const email = prompt("관리자 이메일을 입력하세요:");
      if (email) {
        localStorage.setItem("admin", email);
        alert("관리자 설정 완료!");
        checkAdmin();
      }
    }

    function isAdmin() {
      return localStorage.getItem("admin") === "dogfightda@gmail.com";
    }

    function checkAdmin() {
      const adminSection = document.getElementById("adminSection");
      const authInfo = document.getElementById("authInfo");
      const adminButton = document.getElementById("adminButton");
      const currentUser = localStorage.getItem("admin");

      const isAdminUser = isAdmin();
      adminSection.style.display = isAdminUser ? "block" : "none";

      if (currentUser) {
        authInfo.style.display = "inline-block";
        adminButton.style.display = "none";
        document.getElementById("authStatus").textContent = currentUser;
      } else {
        authInfo.style.display = "none";
        adminButton.style.display = "inline-block";
      }
    }

    function logout() {
      localStorage.removeItem("admin");
      alert("로그아웃 되었습니다.");
      checkAdmin();
    }

    function openBoss() {
      const bossId = document.getElementById("bossId").value;
      if (!bossId) return alert("보스 ID를 입력하세요!");
      const timestamp = Date.now();
      db.ref("bosses/" + bossId).set({ open: true, timestamp });
    }

    function participate(bossId) {
      const nickname = localStorage.getItem("nickname");
      if (!nickname) return alert("닉네임을 먼저 저장해주세요!");
      db.ref("bosses/" + bossId + "/participants/" + nickname).set(true);
    }

    function deleteBoss(bossId) {
      if (!confirm(`${bossId} 보스를 삭제하시겠습니까?`)) return;
      db.ref("bosses/" + bossId).remove();
    }

    function deleteParticipant(bossId, nickname) {
      if (!confirm(`${nickname}을(를) 삭제하시겠습니까?`)) return;
      db.ref("bosses/" + bossId + "/participants/" + nickname).remove();
    }

    function loadBosses() {
      db.ref("bosses").on("value", (snap) => {
        const data = snap.val();
        const container = document.getElementById("bossList");
        container.innerHTML = "";
        const now = Date.now();
        for (const bossId in data) {
          const boss = data[bossId];
          const openTime = boss.timestamp || 0;
          const withinTime = (now - openTime) < (6 * 60 * 60 * 1000);
          const disabled = withinTime ? "" : "btn-disabled";
          const label = withinTime ? "참여" : "참여 불가";

          let html = `<div class="boss"><h3>${bossId} <span style=\"font-size:0.9em; color:#666;\">(${new Date(openTime).toLocaleString("ko-KR")})</span>`;
          if (isAdmin()) {
            html += ` <span class="admin-delete" onclick="deleteBoss('${bossId}')">[보스 삭제]</span>`;
          }
          html += `</h3><button class="${disabled}" onclick="${withinTime ? `participate('${bossId}')` : `alert('참여 시간이 지났습니다.')`}">${label}</button>`;

          html += `<div class="participants">`;
          if (boss.participants) {
            html += "<ul>";
            for (const nick in boss.participants) {
              html += `<li>${nick}`;
              if (isAdmin()) {
                html += ` <span class="admin-delete" onclick="deleteParticipant('${bossId}', '${nick}')">[삭제]</span>`;
              }
              html += `</li>`;
            }
            html += "</ul>";
          } else {
            html += "참여자 없음";
          }
          html += "</div></div>";

          container.innerHTML += html;
        }
      });
    }

    window.onload = function () {
      const savedNickname = localStorage.getItem("nickname");
      if (savedNickname) {
        document.getElementById("nickname").value = savedNickname;
      }
      checkAdmin();
      loadBosses();
    }
  
    function downloadCSV() {
      db.ref("bosses").once("value", (snap) => {
        const data = snap.val();
        let csvContent = "보스ID,보스오픈시간,닉네임\n";
        for (const bossId in data) {
          const boss = data[bossId];
          const openTime = boss.timestamp ? new Date(boss.timestamp).toLocaleString("ko-KR") : "";
          if (boss.participants) {
            for (const nick in boss.participants) {
              csvContent += `"${bossId}","${openTime}","${nick}"\n`;
            }
          } else {
            csvContent += `"${bossId}","${openTime}",""\n`;
          }
        }

        const blob = new Blob(["\uFEFF" + csvContent], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "보스참여자목록.csv";
        a.click();
        URL.revokeObjectURL(url);
      });
    }
</script>
</body>
</html>
