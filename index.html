
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<title>ëŒ€ì¥ê¸¸ë“œ ì°¸ì—¬ì ì²´í¬</title>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js">
    );
        for (const bossId of sortedBossIds) {
          const boss = data[bossId];
          const openTime = boss.timestamp ? new Date(boss.timestamp).toLocaleString("ko-KR") : "";
          if (boss.participants) {
            for (const nick in boss.participants) {
              csvContent += `"${bossId}","${openTime}","${nick}"
`;
            }
          } else {
            csvContent += `"${bossId}","${openTime}",""
`;
          }
        }

        const blob = new Blob(["ï»¿" + csvContent], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "ë³´ìŠ¤ì°¸ì—¬ìëª©ë¡.csv";
        a.click();
        URL.revokeObjectURL(url);
      });
    }
</script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js">
    function downloadCSV() {
      db.ref("bosses").once("value", (snap) => {
        const data = snap.val();
        let csvContent = "ë³´ìŠ¤ID,ë³´ìŠ¤ì˜¤í”ˆì‹œê°„,ë‹‰ë„¤ì„
";
        const sortedBossIds = Object.keys(data).sort((a, b) => {
          const ta = data[a].timestamp || 0;
          const tb = data[b].timestamp || 0;
          return tb - ta;
        });
        for (const bossId of sortedBossIds) {
          const boss = data[bossId];
          const openTime = boss.timestamp ? new Date(boss.timestamp).toLocaleString("ko-KR") : "";
          if (boss.participants) {
            for (const nick in boss.participants) {
              csvContent += `"${bossId}","${openTime}","${nick}"
`;
            }
          } else {
            csvContent += `"${bossId}","${openTime}",""
`;
          }
        }

        const blob = new Blob(["ï»¿" + csvContent], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "ë³´ìŠ¤ì°¸ì—¬ìëª©ë¡.csv";
        a.click();
        URL.revokeObjectURL(url);
      });
    }
</script>
<style>
    body {
      font-family: 'Segoe UI', 'Pretendard', sans-serif;
      background-color: #f9f9f9;
      color: #222;
      margin: 0;
      padding: 1rem;
    }

    header {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      align-items: flex-start;
      background-color: #ffffff;
      padding: 1rem;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      margin-bottom: 1.5rem;
    }

    h1 {
      font-size: 1.5rem;
      margin: 0;
      color: #333;
    }

    #adminButton, #authInfo {
      align-self: flex-end;
    }

    #authInfo {
      background: #e3f2fd;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      display: none;
      color: #222;
    }

    label, input, button {
      font-size: 1rem;
    }

    input {
      padding: 0.5rem;
      margin: 0.3rem 0.5rem 0.3rem 0;
      border: 1px solid #ccc;
      border-radius: 6px;
      background-color: #fff;
      color: #222;
      width: 100%;
      max-width: 300px;
    }

    button {
      padding: 0.5rem 1rem;
      background-color: #1976d2;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    button:hover {
      background-color: #1565c0;
    }

    .btn-disabled {
      background-color: #e0e0e0;
      color: #888;
      border: 1px dashed #aaa;
      cursor: not-allowed;
    }

    .section {
      margin-bottom: 1.5rem;
      background: #ffffff;
      padding: 1rem;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }

    .boss {
      background: #fafafa;
      border-radius: 10px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .boss h3 {
      margin-top: 0;
      color: #222;
    }

    .participants {
      margin-top: 0.5rem;
      font-size: 0.9rem;
      color: #333;
    }

    .admin-delete {
      color: #d32f2f;
      cursor: pointer;
      margin-left: 0.5rem;
    }

    #scoreSummary {
      background: #ffffff;
      border-radius: 10px;
      padding: 1rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }

    #scoreSummary h3 {
      color: #1976d2;
    }

    #scoreSummary li {
      color: #333;
    }

    @media screen and (min-width: 768px) {
      header {
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
      }

      input {
        width: auto;
      }
    }
</style>
</head>
<body>
<header>
<h1>ğŸ”¥ ëŒ€ì¥ê¸¸ë“œ ì°¸ì—¬ì ì²´í¬</h1>
<button id="adminButton" onclick="setAdmin()">ğŸ” ê´€ë¦¬ì ì„¤ì •</button>
<div id="authInfo">
      ë¡œê·¸ì¸: <span id="authStatus">-</span>
<button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
</div>
</header>
<div id="scoreSummary" style="margin-bottom: 2rem; background: #fff; border-radius: 10px; padding: 1rem; box-shadow: 0 2px 6px rgba(0,0,0,0.1);"></div>

<div class="section">
<label>ë‹‰ë„¤ì„:
      <input id="nickname" placeholder="ë‹‰ë„¤ì„ ì…ë ¥" type="text"/>
</label>
<button onclick="saveNickname()">ë‹‰ë„¤ì„ ì €ì¥</button>
</div>
<div class="section" id="adminSection" style="display:none;">
<label>ë³´ìŠ¤ ID:<input id="bossId" placeholder="ë³´ìŠ¤ ì´ë¦„ ììœ ì…ë ¥"/></label><input id="bossScore" placeholder="ì ìˆ˜ ì…ë ¥" type="number"/><button onclick="openBoss()">ë³´ìŠ¤ ì˜¤í”ˆ</button></div>
<div class="section">
<h2>âœ… ì˜¤í”ˆëœ ë³´ìŠ¤ <span style="font-size: 0.85rem; color: #666;">(ë³´ìŠ¤ ì˜¤í”ˆ í›„ 6ì‹œê°„ ë™ì•ˆë§Œ ì°¸ì—¬ ì²´í¬ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤. ë˜í•œ ë°ì´í„° ì‚­ì œ í•„ìš” ì‹œ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜ ì£¼ì„¸ìš”.)</span></h2>
<div style="text-align: right;"><!-- <button onclick="downloadCSV()">CSV ë‹¤ìš´ë¡œë“œ</button> --><button onclick="downloadCSV()" style="background-color: #43a047; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; font-weight: bold; margin-right: 10px;">ğŸ“¥ CSV ë‹¤ìš´ë¡œë“œ</button><button id="deleteAllButton" onclick="confirmAndDeleteAll()" style="background-color: #d32f2f; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; font-weight: bold;">ì „ì²´ ì‚­ì œ</button></div>


<div id="bossList"></div>
</div>
<script>
    const firebaseConfig = {
      apiKey: "AIzaSyAY6Ff6uZ-iZ7soeuXBU0mtTKKZZ8gAPck",
      authDomain: "bossraidtracker.firebaseapp.com",
      databaseURL: "https://bossraidtracker-default-rtdb.firebaseio.com",
      projectId: "bossraidtracker",
      storageBucket: "bossraidtracker.appspot.com",
      messagingSenderId: "975753692062",
      appId: "1:975753692062:web:0991fb5bcbc52a9d3d0c8f",
      measurementId: "G-MC8YY38ZP3"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function saveNickname() {
      const nickname = document.getElementById("nickname").value;
      if (nickname) {
        localStorage.setItem("nickname", nickname);
        alert("ë‹‰ë„¤ì„ ì €ì¥ ì™„ë£Œ!");
      }
    }

    function setAdmin() {
      const email = prompt("ê´€ë¦¬ì ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”:");
      const password = prompt("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
      if (email === "dogfightda@gmail.com" && password === "0716") {
        localStorage.setItem("admin", email);
        alert("ê´€ë¦¬ì ì¸ì¦ ì„±ê³µ!");
        checkAdmin();
   // ë¡œê·¸ì¸ í›„ ì¦‰ì‹œ ì²´í¬
        updateDeleteButtonVisibility(); // ë¡œê·¸ì¸ í›„ ì‚­ì œ ë²„íŠ¼ ìƒíƒœ ì¦‰ì‹œ ê°±ì‹ 
        window.location.reload(); // ë¡œê·¸ì¸ í›„ í˜ì´ì§€ ìƒˆë¡œ ê³ ì¹¨
      } else {
        alert("ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      }
    }

    function isAdmin() {
      return localStorage.getItem("admin") === "dogfightda@gmail.com";
    }

    function checkAdmin() {
      const adminSection = document.getElementById("adminSection");
      const authInfo = document.getElementById("authInfo");
      const adminButton = document.getElementById("adminButton");
      const currentUser = localStorage.getItem("admin");

      const isAdminUser = isAdmin();
      adminSection.style.display = isAdminUser ? "block" : "none";
      

      if (currentUser) {
        authInfo.style.display = "inline-block";
        adminButton.style.display = "none";
        document.getElementById("authStatus").textContent = currentUser;
      } else {
        authInfo.style.display = "none";
        adminButton.style.display = "inline-block";
      }

      // ì‚­ì œ ë²„íŠ¼ ì¦‰ì‹œ ê°±ì‹ 
      updateDeleteButtonVisibility();
    }

    function updateDeleteButtonVisibility() {
      const deleteAllBtn = document.getElementById("deleteAllButton");
      if (deleteAllBtn) {
        deleteAllBtn.style.display = isAdmin() ? "inline-block" : "none";
      }
    }

    function logout() {
      localStorage.removeItem("admin");
      alert("ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.");
      checkAdmin();
  
      updateDeleteButtonVisibility();
      window.location.reload(); // ë¡œê·¸ì•„ì›ƒ í›„ í˜ì´ì§€ ìƒˆë¡œ ê³ ì¹¨
    }

    function openBoss() {
      const bossId = document.getElementById("bossId").value;
      if (!bossId) return alert("ë³´ìŠ¤ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”!");
      const score = parseInt(document.getElementById("bossScore").value) || 0;
      const timestamp = Date.now();
      db.ref("bosses/" + bossId).set({ open: true, timestamp, score });
    }

    function participate(bossId) {
      const nickname = localStorage.getItem("nickname");
      if (!nickname) return alert("ë‹‰ë„¤ì„ì„ ë¨¼ì € ì €ì¥í•´ì£¼ì„¸ìš”!");
      db.ref("bosses/" + bossId + "/score").once("value", (snap) => {
        const score = snap.val() || 0;
        db.ref("bosses/" + bossId + "/participants/" + nickname).set({ score }).then(() => {
          alert(`${nickname} ì°¸ì—¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`);
          window.location.reload(); // ì°¸ì—¬ ì™„ë£Œ í›„ í˜ì´ì§€ ìƒˆë¡œ ê³ ì¹¨
        });
      });
    }

    function deleteBoss(bossId) {
      if (!isAdmin()) {
        alert("ê´€ë¦¬ìë§Œ ë³´ìŠ¤ë¥¼ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
        return;
      }
      if (!confirm(`${bossId} ë³´ìŠ¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
      db.ref("bosses/" + bossId).remove().then(() => {
        alert("ë³´ìŠ¤ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        window.location.reload(); // ì‚­ì œ í›„ í˜ì´ì§€ ìƒˆë¡œ ê³ ì¹¨
      });
    }

    function deleteParticipant(bossId, nickname) {
      if (!confirm(`${nickname}ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
      db.ref("bosses/" + bossId + "/participants/" + nickname).remove().then(() => {
        alert(`${nickname}ì´(ê°€) ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
        window.location.reload(); // ì‚­ì œ í›„ í˜ì´ì§€ ìƒˆë¡œ ê³ ì¹¨
      });
    }

    function loadBosses() {
      db.ref("bosses").on("value", (snap) => {
        const data = snap.val();
        const container = document.getElementById("bossList");
        container.innerHTML = "";
        const now = Date.now();
        const sortedBossIds = Object.keys(data).sort((a, b) => {
          const ta = data[a].timestamp || 0;
          const tb = data[b].timestamp || 0;
          return tb - ta;
        });
        for (const bossId of sortedBossIds) {
          const boss = data[bossId];
          const openTime = boss.timestamp || 0;
          const withinTime = (now - openTime) < (6 * 60 * 60 * 1000);
          const disabled = withinTime ? "" : "btn-disabled";
          const label = withinTime ? "ì°¸ì—¬" : "ì°¸ì—¬ ë¶ˆê°€";

          let html = `<div class="boss"><h3>${bossId} <span style="font-size:0.9em; color:#666;">(${new Date(openTime).toLocaleString("ko-KR")})</span>`;
          if (isAdmin()) {
            html += ` <span class="admin-delete" onclick="deleteBoss('${bossId}')">[ë³´ìŠ¤ ì‚­ì œ]</span>`;
          }
          html += `</h3><button class="${disabled}" onclick="${withinTime ? `participate('${bossId}')` : `alert('ì°¸ì—¬ ì‹œê°„ì´ ì§€ë‚¬ìŠµë‹ˆë‹¤.')`}">${label}</button>` + `<button style="margin-left: 10px; background-color: #e91e63; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-weight: bold;" onclick="cancelParticipation('${bossId}')">ì·¨ì†Œ</button>`;

          html += `<div class="participants">`;
          if (boss.participants) {
            html += "<ul>";
            for (const nick in boss.participants) {
              html += `<li>${nick} (${boss.participants[nick].score || 0}ì )`;
              if (isAdmin()) {
                html += ` <span class="admin-delete" onclick="deleteParticipant('${bossId}', '${nick}')">[ì‚­ì œ]</span>`;
              }
              html += `</li>`;
            }
            html += "</ul>";
          } else {
            html += "ì°¸ì—¬ì ì—†ìŒ";
          }
          html += "</div></div>";

          container.innerHTML += html;
        }
      });
    }

    function displayTotalScores() {
      db.ref("bosses").once("value", (snap) => {
        const data = snap.val();
        const totalScores = {};

        for (const bossId in data) {
          const boss = data[bossId];
          if (boss.participants) {
            for (const nick in boss.participants) {
              const score = boss.participants[nick].score || 0;
              totalScores[nick] = (totalScores[nick] || 0) + score;
            }
          }
        }

        // Sort the scores in descending order
        const sortedScores = Object.entries(totalScores).sort((a, b) => b[1] - a[1]);

        const summaryDiv = document.getElementById("scoreSummary");
        summaryDiv.innerHTML = "<h3>ğŸ”¥ ë‹‰ë„¤ì„ë³„ ëˆ„ì  ì ìˆ˜</h3><ul>" + 
          sortedScores
            .map(([nick, score]) => `<li><strong>${nick}</strong>: ${score}ì </li>`)
            .join("") + 
          "</ul>";
      });
    }

window.onload = function () {
  displayTotalScores();
  const savedNickname = localStorage.getItem("nickname");
  if (savedNickname) {
    document.getElementById("nickname").value = savedNickname;
  }
  checkAdmin();
  
  loadBosses();
}

function confirmAndDeleteAll() {
  if (!isAdmin()) {
    alert("ê´€ë¦¬ìë§Œ ì „ì²´ ì‚­ì œê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
    return;
  }
  if (!confirm("ì •ë§ ëª¨ë“  ë³´ìŠ¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

  db.ref("bosses").remove().then(() => {
    alert("ì „ì²´ ë³´ìŠ¤ ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
    window.location.reload(); // ì‚­ì œ í›„ í˜ì´ì§€ ìƒˆë¡œ ê³ ì¹¨
  }).catch((error) => {
    console.error("ì „ì²´ ì‚­ì œ ì‹¤íŒ¨:", error);
    alert("ì „ì²´ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
  });
}



function downloadCSV() {
  db.ref("bosses").once("value", (snap) => {
    const data = snap.val();
    let csvContent = "ë³´ìŠ¤ID,ë³´ìŠ¤ì˜¤í”ˆì‹œê°„,ë‹‰ë„¤ì„,ì ìˆ˜\n";
    const sortedBossIds = Object.keys(data).sort((a, b) => {
      const ta = data[a].timestamp || 0;
      const tb = data[b].timestamp || 0;
      return tb - ta;
    });
    for (const bossId of sortedBossIds) {
      const boss = data[bossId];
      const openTime = boss.timestamp ? new Date(boss.timestamp).toLocaleString("ko-KR") : "";
      if (boss.participants) {
        for (const nick in boss.participants) {
          const score = boss.participants[nick].score || 0;
          csvContent += `"\${bossId}","\${openTime}","\${nick}","\${score}"\n`;
        }
      } else {
        csvContent += `"\${bossId}","\${openTime}","",""\n`;
      }
    }
    const blob = new Blob(["ï»¿" + csvContent], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "ë³´ìŠ¤ì°¸ì—¬ìëª©ë¡.csv";
    a.click();
    URL.revokeObjectURL(url);
  });
}


function downloadCSV() {
  db.ref("bosses").once("value", (snap) => {
    const data = snap.val();
    let csvContent = "ë³´ìŠ¤ID,ë³´ìŠ¤ì˜¤í”ˆì‹œê°„,ë‹‰ë„¤ì„,ì ìˆ˜\n";
    const sortedBossIds = Object.keys(data).sort((a, b) => {
      const ta = data[a].timestamp || 0;
      const tb = data[b].timestamp || 0;
      return tb - ta;
    });
    for (const bossId of sortedBossIds) {
      const boss = data[bossId];
      const openTime = boss.timestamp ? new Date(boss.timestamp).toLocaleString("ko-KR") : "";
      if (boss.participants) {
        for (const nick in boss.participants) {
          const score = boss.participants[nick].score || 0;
          csvContent += '"' + bossId + '","' + openTime + '","' + nick + '","' + score + '"\n';
        }
      } else {
        csvContent += '"' + bossId + '","' + openTime + '","",""\n';
      }
    }
    const blob = new Blob(["\uFEFF" + csvContent], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "ë³´ìŠ¤ì°¸ì—¬ìëª©ë¡.csv";
    a.click();
    URL.revokeObjectURL(url);
  });
}


function cancelParticipation(bossId) {
  const nickname = localStorage.getItem("nickname");
  if (!nickname) return alert("ë‹‰ë„¤ì„ì´ ì €ì¥ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.");
  if (!confirm(`${nickname}ë‹˜ì˜ ì°¸ì—¬ë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

  db.ref("bosses/" + bossId + "/participants/" + nickname).remove().then(() => {
    alert("ì°¸ì—¬ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    window.location.reload();
  });
}

</script>
</body>
</html>
